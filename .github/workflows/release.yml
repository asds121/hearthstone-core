name: Release

on:
  push:
    tags:
      - 'v*'

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write
    
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Use Node.js 18.x
      uses: actions/setup-node@v4
      with:
        node-version: 18.x
        registry-url: 'https://registry.npmjs.org'
        cache: 'npm'
    
    - name: Install dependencies
      run: |
        echo "=== Installing dependencies ==="
        npm ci
        echo "=== Verifying installation ==="
        npm list --depth=0 || echo "Package list completed"
    
    - name: Debug test setup
      run: |
        echo "=== Comprehensive Test Debug ==="
        echo "Working directory: $(pwd)"
        echo "=== Directory structure ==="
        find . -type d -name "src" -o -name "tests" | head -10
        echo "=== Jest config files ==="
        ls -la jest.*.config.js || echo "No Jest config files found"
        echo "=== TypeScript config files ==="
        ls -la tsconfig*.json || echo "No TypeScript config files found"
        echo "=== Test files with different patterns ==="
        echo "Pattern 1: find . -name '*.test.ts'"
        find . -name "*.test.ts" -type f || echo "No test files found with pattern 1"
        echo "Pattern 2: find . -path '*/src/tests/*.test.ts'"
        find . -path "*/src/tests/*.test.ts" -type f || echo "No test files found with pattern 2"
        echo "Pattern 3: find . -path '*/src/tests/*.test.ts'"
        find . -path "*/src/tests/*.test.ts" -type f || echo "No test files found with pattern 3"
        echo "=== Detailed src/tests directory check ==="
        if [ -d "src/tests" ]; then
          echo "src/tests directory exists"
          ls -la src/tests/
          echo "Files in src/tests:"
          find src/tests/ -name "*.test.ts" -exec echo "Found: {}" \;
        else
          echo "src/tests directory does not exist"
        fi
        echo "=== Running Jest diagnostic script ==="
        node scripts/diagnose-tests.js || echo "Diagnostic script failed"
        echo "=== Testing Jest with different configs ==="
        echo "Testing with release config:"
        npx jest --config jest.release.config.js --listTests || echo "Jest list with release config failed"
        echo "Testing with fixed release config:"
        npx jest --config jest.release.fixed.config.js --listTests || echo "Jest list with fixed release config failed"
        echo "=== Environment info ==="
        echo "Node version: $(node --version)"
        echo "NPM version: $(npm --version)"
        echo "Platform: $(uname -a)"
        
    - name: Run tests with fail-safe
      run: |
        echo "=== Attempting to run tests ==="
        
        # 方法1: 使用标准的release配置
        echo "方法1: 使用标准的release配置"
        if npm run test:release; then
          echo "✅ 方法1成功"
          exit 0
        fi
        
        echo "❌ 方法1失败，尝试方法2"
        # 方法2: 使用修复的配置
        echo "方法2: 使用修复的release配置"
        if npx jest --config jest.release.fixed.config.js --ci --verbose --passWithNoTests=false; then
          echo "✅ 方法2成功"
          exit 0
        fi
        
        echo "❌ 方法2失败，尝试方法3"
        # 方法3: 使用Linux专用配置
        echo "方法3: 使用Linux专用配置"
        if npx jest --config jest.linux.config.js --ci --verbose --passWithNoTests=false; then
          echo "✅ 方法3成功"
          exit 0
        fi
        
        echo "❌ 方法3失败，尝试方法4"
        # 方法4: 直接指定文件路径
        echo "方法4: 直接指定文件路径"
        if npx jest --config jest.release.config.js --ci --verbose --passWithNoTests=false src/tests/entity.test.ts src/tests/event.test.ts src/tests/game.test.ts; then
          echo "✅ 方法4成功"
          exit 0
        fi
        
        echo "❌ 所有方法都失败"
        echo "最终诊断:"
        echo "=== 通用诊断 ==="
        node scripts/diagnose-tests.js
        echo "=== Linux特定诊断 ==="
        node scripts/diagnose-linux-tests.js
        exit 1
      continue-on-error: false
    
    - name: Build project
      run: |
        echo "=== Building project ==="
        npm run build
        echo "=== Verifying build artifacts ==="
        ls -la dist/ || echo "No dist directory found"
    
    - name: Generate documentation
      run: npm run docs
    
    - name: Create Release
      uses: softprops/action-gh-release@v2
      with:
        files: |
          dist/**
          docs/**
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Publish to NPM
      run: npm publish
      env:
        NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
    
    - name: Deploy documentation
      uses: peaceiris/actions-gh-pages@v4
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./docs